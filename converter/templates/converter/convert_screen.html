{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Converter Screen</title>
  <link rel="stylesheet" href="{% static 'converter/styles.css' %}">
</head>
<body>
  <div class="converter-container">
    
    <!-- Full Dataset Popup Window-->
    <div class="popup" id="dataset_popup">
      <div class="dataset_content">
        <div class="popup-header">
          <h2 class="popup-title">Full Dataset</h2>
        </div>
        <table class="csv-table">
          <thead>
            <tr>
              {% for header in headers %}
                <th>{{ header }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in full_table %}
              <tr>
                {% for cell in row %}
                  <td>{{ cell }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
        <button class="close-button" onclick="closeDatasetForm()">Close</button>
      </div>
    </div>
    <!-- End Of Full Datase Popup Window-->

    <!-- HELPER POPUPS-->
    <!-- Request Type Popup-->
    <div class="helper-popup" id="request-type-helper"> 
      <div class="helper-popup-content">
        <div class="helper-popup-header">
          <h2 class="helper-popup-title" id="helper_title">Request Type</h2>
        </div>
        <div class="helper-popup-body" id="helper_body">
          <p><strong>Single:</strong> Returns the best vocabulary suggestion for each column independently.</p>
          <p><strong>Homogenous:</strong> Finds a single vocabulary that works well for all columns together.</p>
        </div>
        <button class="close-button" onclick="closeHelperPopup('request-type-helper')">Close</button>
      </div>
    </div>

    <!-- Vocabulary Recommender Helper Popup -->
    <div class="helper-popup" id="vocabulary-recommender-helper"> 
      <div class="helper-popup-content">
        <div class="helper-popup-header">
          <h2 class="helper-popup-title">Vocabulary Recommendations</h2>
        </div>
        <div class="helper-popup-body">
          <p>Each card represents a column from your uploaded CSV file. It shows the column name, its detected data type, and how many unique values it contains. Use the 'Show Matches' button to view vocabulary suggestions tailored for that specific column.</p>
        </div>
        <button class="close-button" onclick="closeHelperPopup('vocabulary-recommender-helper')">Close</button>
      </div>
    </div>
    

    {{ all_matches|json_script:"all-matches-data" }}
    {{ vocab_coverage_score|json_script:"vocab-coverage-score-data" }}
    {{ sorted_vocabs|json_script:"sorted-vocabs-data" }}
    {{ best_match_index|json_script:"best-match-index-data"}}
    {{ headers|json_script:"headers"}}
    <!-- Resizable match window -->
    <div class="match-container" id="matchContainer">
      <div class="match-resizer" id="matchResizer">...</div>
      <div class="match-header" id="matchHeader">
        <h2 class="match-header-text" id="match-header-text">Matches</h2>
        <button class="match-close" onclick="closeHelperPopup('matchContainer')">x</button>
      </div>
      <div class="match-content" id="match-content">
        <div class="best-match-table" id="best-match-table">
          <h2 class="he1"> Best Match</h2>
          <table class="match-table" id="best-match-table-element"></table>
        </div>
        <div class="all-match-table">
          <h2 class="he1"> All Matches</h2>
          <table class="match-table" id="match-table"></table>
        </div>
      </div>
    </div>

    <div class="insert-popup" id="insert-popup">
      <div class="insert-popup-content">
        <h2>Select Action</h2>
        <div class="insert-popup-buttons">
          <form method="POST" class="insert-match-form" action="{% url 'insert_match' %}">
            {% csrf_token %}
            <button class="insert-btn" id="insert-btn">Insert</button>
          </form>
          <button class="cancel-btn" id="cancel-btn" onclick="closeHelperPopup('insert-popup')">Cancel</button>
        </div>
      </div>
    </div>
    <!-- MAIN CONTENT DIVIDED IN 3 SECTIONS-->

    <!-- LEFT: CSV Preview -->
    <section class="panel panel-left">
      <h2 class="panel-title">CSV Preview</h2>
      
      <!-- Dynamically initialize the csv table preview -->
      <table class="csv-table">
        <thead>
          <tr>
            {% for header in headers %}
              <th>{{ header }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in rows %}
            <tr>
              {% for cell in row %}
                <td>{{ cell }}</td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    
      <button type="button" class="load-button" onclick="openDatasetForm()">Load Full Dataset</button>
  
    </section>

    <!-- MIDDLE: Vocabulary Recommender -->
    <section class="panel panel-middle">

      <h2 class="panel-title">Vocabulary Recommender</h2>

      <!-- Upper subtitle with the helper button -->
      <hr class="solid-separator">
      <div class="request-type-separator">
        <p class="sub-title">Choose Request type</p>
        <button class="helper-button" onclick="openHelperPopup('request-type-helper')">?</button>
      </div>
      <hr class="solid-separator">

      <!-- Request type section -->
      <div class="request-type-container">

        <!-- Request Type buttons: Form(Button)-->
        <form method="POST" class='request-type-form' action="{% url 'set_request_type' 'Homogenous' %}">
          {% csrf_token %}
          <button class="request-type-button {% if request_type == 'Homogenous' %}active{% endif %}" id="homogenous-button">Homogenous</button>
        </form>
        <form method="POST" class="request-type-form"action="{% url 'set_request_type' 'Single' %}">
          {% csrf_token %}
          <button class="request-type-button {% if request_type == 'Single' %}active{% endif %}" id="single-button">Single</button>
        </form>

      </div>
      <div class="replace-all-container">

        <form method="POST" class='request-type-form' action="{% url 'replace_all' %}">
          {% csrf_token %}
          <button class="replace-all-button">Replace All</button>
        </form>
        
      </div>

      <!-- Bottom subtitle with the helper button -->
      <hr class="solid-separator">
      <div class="request-type-separator">
        <p class="sub-title">Vocabulary Recommender Results</p>
        <button class="helper-button" onclick="openHelperPopup('vocabulary-recommender-helper')">?</button>
      </div>
      <hr class="solid-separator">

      <div class="search-block">
        <input type="text" class="header-search" id="header-search" placeholder="Enter header name">
        <button class="search-button" id="search-button">Show Matches</button>
      </div>

      <!-- Card Section -->
      <div class="card-container">

        <!-- Vocabulary Scores Card -->
        <div class="card">
          <h4><strong>Vocabulary Scores</strong></h4>
          <p>Vocabularies: </p>
          <button class="card-button" id='card-button' data-header="Vocabularies">Show Scores</button>
        </div>
      
        <!-- Header Cards -->
        {% for header in headers %}
          <div class="card">
            <p><strong>Header:</strong> {{ header }}</p>
            <p>Type: {{ header }}  |  Matches: </p>
            <button class="card-button" data-header="{{ header }}">Show Matches</button>
          </div>
        {% endfor %}
      
      </div>

    </section>

    <!-- RIGHT: JSON Preview -->
    <section class="panel panel-right">

      <h2 class="panel-title">JSON Preview</h2>

      <!-- JSON text editing area -->
      <div class="json-preview-container">
        <textarea class="json-textarea" id="jsonPreview" placeholder="JSON content will appear here...">{{ json_content }}</textarea>

        <!-- Buttons to save and convert -->
        <div class="json-buttons">
          <form method="POST" class='save-file-form' action="{% url 'save_file' %}">
            {% csrf_token %}
            <button class="json-button save-button">Save</button>
          </form>
          <button class="json-button convert-button" onclick="triggerNQuadsConversion()">Convert</button>
        </div>
      </div>

    </section>

  </div>
  
  <script src="{% static 'converter/main.js' %}"></script>
</body>
</html>
